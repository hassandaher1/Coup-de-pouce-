{% extends "base.html" %}
{% load static %}

{% block title %}Ressourcerie - Découvrir les produits{% endblock %}

{% block header %}
<nav class="site-header">
    <div class="site-header__container">
        <a href="{% url 'public_home' %}" class="site-header__logo">
            <img src="{% static 'images/logo-ressourcerie.png' %}" alt="Ressourcerie" class="site-header__logo-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
            <span class="site-header__logo-text">Ressourcerie</span>
        </a>
        <div class="site-header__actions">
            <a href="tel:{{ phone_clean|default:'0123456789' }}" class="site-header__cta site-header__cta--phone" title="Appeler {{ phone_number|default:'01 23 45 67 89' }}">
                <svg class="site-header__cta-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
                <span>{{ phone_number|default:"01 23 45 67 89" }}</span>
            </a>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<header class="top-hero top-hero--public">
    <div class="top-hero__overlay"></div>
    <div class="top-hero__content">
        <form method="get" class="search-bar">
            {% if category %}
                <input type="hidden" name="category" value="{{ category }}">
            {% endif %}
            <input
                type="search"
                name="q"
                value="{{ query }}"
                class="search-bar__input"
                placeholder="Rechercher un objet, une matière, une catégorie...">
            <button type="submit" class="search-bar__button">Rechercher</button>
        </form>
        <div class="filters">
            <a class="filters__chip filters__chip--ghost {% if not category %}filters__chip--active{% endif %}"
               href="{% if query %}?q={{ query|urlencode }}{% else %}/{% endif %}">Tout</a>
            {% for value, label in categories %}
                <a class="filters__chip {% if category == value %}filters__chip--active{% endif %}"
                   href="?category={{ value }}{% if query %}&q={{ query|urlencode }}{% endif %}">
                    {{ label }}
                </a>
            {% endfor %}
        </div>
    </div>
</header>

<main class="screen screen--with-hero">
    {% if products_by_category %}
        {# Affichage par catégorie avec scroll horizontal sur mobile #}
        {% for cat_label, cat_products in products_by_category.items %}
            <section class="section section--category">
                <h2 class="section-title">{{ cat_label }}</h2>
                <div class="cards-scroll">
                    {% for product in cat_products %}
                        <article class="card card--product card--scroll" data-product-id="{{ product.id }}"
                                 data-product-title="{{ product.title|escapejs }}"
                                 data-product-description="{{ product.description|linebreaksbr|escapejs }}"
                                 data-product-dimensions="{{ product.dimensions|escapejs }}"
                                 data-product-image="{% if product.image %}{{ product.image.url }}{% endif %}"
                                 data-product-alt="{{ product.image_alt|default:product.title|escapejs }}">
                            <div class="card__image-wrapper">
                                {% if product.image %}
                                    <img src="{{ product.image.url }}" alt="{{ product.image_alt|default:product.title }}">
                                {% endif %}
                            </div>
                            <div class="card__body">
                                <h3 class="card__title">{{ product.title }}</h3>
                                {% if product.dimensions %}
                                    <p class="card__meta">{{ product.dimensions }}</p>
                                {% endif %}
                                <p class="card__excerpt">
                                    {{ product.description|truncatechars:60 }}
                                </p>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            </section>
        {% empty %}
            <section class="section">
                <p class="empty-state-text">Aucun produit n'est disponible pour le moment.</p>
            </section>
        {% endfor %}
    {% else %}
        {# Affichage normal (filtre ou recherche active) #}
        <section class="section">
            <h2 class="section-title">Les dernières trouvailles</h2>
            <div class="cards-grid">
                {% for product in products %}
                    <article class="card card--product" data-product-id="{{ product.id }}"
                             data-product-title="{{ product.title|escapejs }}"
                             data-product-description="{{ product.description|linebreaksbr|escapejs }}"
                             data-product-dimensions="{{ product.dimensions|escapejs }}"
                             data-product-image="{% if product.image %}{{ product.image.url }}{% endif %}"
                             data-product-alt="{{ product.image_alt|default:product.title|escapejs }}">
                        <div class="card__image-wrapper">
                            {% if product.image %}
                                <img src="{{ product.image.url }}" alt="{{ product.image_alt|default:product.title }}">
                            {% endif %}
                        </div>
                        <div class="card__body">
                            <h3 class="card__title">{{ product.title }}</h3>
                            <p class="card__meta">{{ product.get_category_display }}</p>
                            {% if product.dimensions %}
                                <p class="card__meta">{{ product.dimensions }}</p>
                            {% endif %}
                            <p class="card__excerpt">
                                {{ product.description|truncatechars:80 }}
                            </p>
                        </div>
                    </article>
                {% empty %}
                    <p class="empty-state-text">Aucun produit n'est disponible pour le moment.</p>
                {% endfor %}
            </div>
        </section>
    {% endif %}
</main>

<footer class="site-footer">
    <div class="site-footer__container">
        <div class="site-footer__content">
            <div class="site-footer__brand">
                <h3 class="site-footer__title">Ressourcerie</h3>
                <p class="site-footer__text">Objets revalorisés, circuits courts, impact local.</p>
            </div>
            <div class="site-footer__links">
                <a href="{% url 'public_home' %}" class="site-footer__link">Accueil</a>
                <a href="tel:{{ phone_clean|default:'0123456789' }}" class="site-footer__link">Contact</a>
            </div>
        </div>
        <div class="site-footer__bottom">
            <p class="site-footer__copy">© {% now "Y" %} Ressourcerie — Reuse & Upcycling</p>
        </div>
    </div>
</footer>

<div class="product-modal" id="productModal" aria-hidden="true">
    <div class="product-modal__backdrop"></div>
    <div class="product-modal__content">
        <button class="product-modal__close" type="button" aria-label="Fermer">×</button>
        <div class="product-modal__image-wrapper">
            <img id="modalImage" src="" alt="">
        </div>
        <div class="product-modal__body">
            <h2 id="modalTitle"></h2>
            <p id="modalDimensions" class="card__meta"></p>
            <p id="modalDescription"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    (function () {
        const modal = document.getElementById('productModal');
        if (!modal) return;

        const backdrop = modal.querySelector('.product-modal__backdrop');
        const closeBtn = modal.querySelector('.product-modal__close');
        const imageEl = document.getElementById('modalImage');
        const titleEl = document.getElementById('modalTitle');
        const dimensionsEl = document.getElementById('modalDimensions');
        const descriptionEl = document.getElementById('modalDescription');

        function openModal(card) {
            const title = card.getAttribute('data-product-title');
            const description = card.getAttribute('data-product-description');
            const dimensions = card.getAttribute('data-product-dimensions');
            const image = card.getAttribute('data-product-image');
            const alt = card.getAttribute('data-product-alt');

            titleEl.textContent = title || '';
            dimensionsEl.textContent = dimensions || '';
            descriptionEl.innerHTML = description || '';

            if (image) {
                imageEl.src = image;
                imageEl.alt = alt || title || '';
                imageEl.style.display = 'block';
            } else {
                imageEl.style.display = 'none';
            }

            modal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('no-scroll');
        }

        function closeModal() {
            modal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('no-scroll');
        }

        document.querySelectorAll('.card--product, .card--scroll').forEach(function (card) {
            card.addEventListener('click', function () {
                openModal(card);
            });
        });

        backdrop.addEventListener('click', closeModal);
        closeBtn.addEventListener('click', closeModal);

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    })();
</script>
{% endblock %}

